<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>شركة الأندلس للتقسيط</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
    body.dark-mode { background: #121212; color: white; }
    .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); margin-top: 40px; }
    body.dark-mode .container { background: #1e1e1e; }
    h2 { text-align: center; margin-bottom: 30px; color: #007bff; }
    select, input, button { padding: 10px; font-size: 16px; border-radius: 5px; width: 100%; }
    .form-group { margin-bottom: 15px; }
    .form-row { display: flex; flex-wrap: wrap; gap: 10px; }
    .form-group.flex-1 { flex: 1; }
    .buttons { display: flex; justify-content: space-between; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    .modal { display: none; position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 400px; max-height: 90vh; overflow-y: auto; position: relative; }
    .close-btn { position: absolute; top: 10px; left: 10px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; }
    .table-box { flex: 1; min-width: 300px; margin-top: 20px; }
    @media print {
      .buttons, .modal, .form-row, .settings-btn { display: none !important; }
    }
  </style>
</head>
<body>

<div class="container">
  <h2>شركة الأندلس للتقسيط</h2>
  <div class="form-row">
    <div class="form-group flex-1">
      <label>الفئة:</label>
      <select id="category"></select>
    </div>
    <div class="form-group flex-1">
      <label>المبلغ المطلوب:</label>
      <input type="number" id="amount" placeholder="مثال: 10000">
    </div>
    <div class="form-group flex-1">
      <label>المقدم:</label>
      <input type="number" id="downPayment" placeholder="مثال: 2000">
    </div>
  </div>
  <div class="buttons">
    <button onclick="calculate()">💰 احسب الأقساط</button>
    <button onclick="openSettings()" class="settings-btn">⚙️ الإعدادات</button>
    <button onclick="exportPDF()">📄 تصدير PDF</button>
    <button onclick="toggleDarkMode()">🌙 الوضع الليلي</button>
  </div>
  <div class="form-row" id="resultTables"></div>
</div>

<!-- نافذة الإعدادات -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeSettings()">×</button>
    <h3>تعديل الفائدة وإدارة الفئات</h3>
    <div id="settingsContent"></div>
    <hr>
    <label>➕ فئة جديدة:</label>
    <input type="text" id="newCategory" placeholder="اسم الفئة الجديدة">
    <input type="number" id="newRate" placeholder="نسبة الفائدة (%)">
    <button onclick="addCategory()">➕ إضافة</button>
    <hr>
    <button onclick="saveSettings()">💾 حفظ التعديلات</button>
  </div>
</div>

<script>
const allDurations = [3, 6, 8, 10, 12, 15, 18, 24, 30, 36];

let saved = localStorage.getItem('interestData');
let interestByCategory = saved ? JSON.parse(saved) : {
  "موبايلات": { "3": 10, "6": 15, "8": 20, "10": 22, "12": 30, "15": 35, "18": 40, "24": 45, "30": 50, "36": 55 },
  "أجهزة كهربائية": { "6": 12, "12": 25, "24": 35 },
  "أثاث": { "6": 10, "12": 20, "24": 30 },
  "ملابس": { "6": 8, "12": 15 }
};

function populateCategoryOptions() {
  const catSelect = document.getElementById("category");
  catSelect.innerHTML = `<option value="">اختر الفئة</option>`;
  for (const cat in interestByCategory) {
    catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
  }
}

function openSettings() {
  const modal = document.getElementById("settingsModal");
  const content = document.getElementById("settingsContent");
  content.innerHTML = '';

  for (const cat in interestByCategory) {
    let inputs = '';
    allDurations.forEach(months => {
      const val = interestByCategory[cat][months] ?? '';
      inputs += `<label>${months} شهر:</label><input type="number" id="rate-${cat}-${months}" value="${val}" style="margin-bottom:5px;">`;
    });
    content.innerHTML += `
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
        <strong>${cat}</strong>
        <button onclick="deleteCategory('${cat}')" style="float:left; background:red; color:white; border:none; padding:2px 6px; border-radius:4px;">🗑️</button>
        <br>${inputs}
      </div>
    `;
  }

  modal.style.display = "flex";
}

function closeSettings() {
  document.getElementById("settingsModal").style.display = "none";
}

function saveSettings() {
  for (const cat in interestByCategory) {
    allDurations.forEach(months => {
      const input = document.getElementById(`rate-${cat}-${months}`);
      if (input) {
        interestByCategory[cat][months] = parseFloat(input.value) || 0;
      }
    });
  }
  localStorage.setItem('interestData', JSON.stringify(interestByCategory));
  populateCategoryOptions();
  closeSettings();
}

function addCategory() {
  const name = document.getElementById("newCategory").value.trim();
  const rate = parseFloat(document.getElementById("newRate").value);
  if (!name || isNaN(rate)) {
    alert("يرجى إدخال اسم الفئة ونسبة الفائدة.");
    return;
  }
  const rates = {};
  allDurations.forEach(months => rates[months] = rate);
  interestByCategory[name] = rates;
  localStorage.setItem('interestData', JSON.stringify(interestByCategory));
  populateCategoryOptions();
  document.getElementById("newCategory").value = '';
  document.getElementById("newRate").value = '';
  openSettings();
}

function deleteCategory(cat) {
  if (confirm(`هل تريد حذف الفئة "${cat}"؟`)) {
    delete interestByCategory[cat];
    localStorage.setItem('interestData', JSON.stringify(interestByCategory));
    populateCategoryOptions();
    openSettings();
  }
}

function roundTo5(num) {
  return Math.round(num / 5) * 5;
}

function calculate() {
  const amount = parseFloat(document.getElementById('amount').value);
  const down = parseFloat(document.getElementById('downPayment').value);
  const category = document.getElementById('category').value;
  const container = document.getElementById('resultTables');
  if (!category || isNaN(amount) || amount <= 0 || isNaN(down) || down < 0 || down > amount) {
    alert("يرجى إدخال بيانات صحيحة.");
    return;
  }

  const remain = amount - down;
  const categoryRates = interestByCategory[category] || {};
  const buildTable = (terms) => {
    let html = `<table><tr><th>عدد الشهور</th><th>القسط</th><th>الإجمالي</th></tr>`;
    terms.forEach(months => {
      const rate = (categoryRates[months] || 0) / 100;
      const interest = remain * rate * (months / 12);
      const total = roundTo5(remain + interest);
      const monthly = roundTo5(total / months);
      html += `<tr><td>${months}</td><td>${monthly} جم</td><td>${total} جم</td></tr>`;
    });
    html += `</table>`;
    return html;
  };

  container.innerHTML = `
    <div class="table-box">${buildTable([3, 6, 8, 10, 12])}</div>
    <div class="table-box">${buildTable([15, 18, 24, 30, 36])}</div>
  `;
}

function exportPDF() {
  const element = document.getElementById("resultTables");
  if (!element.innerHTML.trim()) {
    alert("يرجى أولاً احتساب الأقساط.");
    return;
  }

  const opt = {
    margin: 0.5,
    filename: 'نتيجة-التقسيط.pdf',
    image: { type: 'jpeg', quality: 1 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opt).from(element).save();
}

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
}

window.onload = () => {
  populateCategoryOptions();
};
</script>
</body>
</html>
